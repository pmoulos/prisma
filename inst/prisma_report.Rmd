---
title: PRISMA report
subtitle: "`r cat('A project name here')`"
date: "`r format(Sys.time(), '%d/%m/%Y')`"
output:
  rmdformats::robobook:
    fig_width: 7
    fig_height: 7
    fig_caption: true
    highlight: kate
    lightbox: true
    #thumbnails: true
    #gallery: true
    cards: true
    use_bookdown: false
    mathjax: null
    self_contained: false
---

<style>
.lightbold {
    font-weight: 500;
}

.figure-hint {
    margin: 24px 48px;
    text-align: justify;
    font-size: 0.9em;
}

#opts_container {
    font-size: 0.9em;
    height: 400px;
    overflow-y: scroll;
    overflow-x: hidden;
    overflow-wrap: normal;
}
</style>

```{r knitr_init, echo=FALSE, cache=FALSE}
library(knitr)
library(rmdformats)

# Global options
options(max.print="75")
opts_chunk$set(
    echo=FALSE,
    cache=FALSE,
    prompt=FALSE,
    tidy=TRUE,
    comment=NA,
    message=FALSE,
    warning=FALSE,
    results="asis",
    eval=TRUE,
    fig.align="center"
)
opts_knit$set(width=75)
```

```{r report_init}
library(DT)
library(ggplot2)
library(htmltools)
library(magrittr)
library(pander)

args <- prismaOut$params$args
funCall <- prismaOut$params$call

msgs <- .makeReportMessages("en")
#msgs <- prisma:::.makeReportMessages("en")

theCvMetrics <- list(
    `PRS R<sup>2</sup>`="r2",
    `RMSE`="rmse",
    `MAE`="mae",
    `Predicted R<sup>2</sup>`="pr2",
    `Correlation`="crl"
)

cvMetExpl <- list(
    `PRS R<sup>2</sup>`=paste0(
        "The plots depict the following R2 measurements: ",
        "<ul>",
        "<li>Full regression model R<sup>2</sup>: the R<sup>2</sup> of a ",
            "model including the PRS.</li>",
        "<li>Reduced model R<sup>2</sup>: the R<sup>2</sup> of a model ",
            "without  the PRS (only covariates against the phenotype under ",
            "interrogation).</li>",
        "<li>Adjusted PRS R<sup>2</sup>: Full R<sup>2</sup> – Reduced ",
            "R<sup>2</sup>.</li>",
        "</ul>"
    ),
    `RMSE`=paste0(
        "The plots depict the following RMSE measurements:",
        "<ul>",
        "<li>Full model RMSE (including the covariates and the PRS).</li>",
        "<li>Reduced model RMSE (including only the covariates).</li>",
        "</ul>"
    ),
    `MAE`=paste0(
        "The plots depict the following MAE measurements:",
        "<ul>",
        "<li>Full model MAE (including the covariates and the PRS).</li>",
        "<li>Reduced model MAE (including only the covariates).</li>",
        "</ul>"
    ),
    `Predicted R<sup>2</sup>`=paste0(
        "The plots depict the following R2 measurements:",
        "<ul>",
        "<li>R<sup>2</sup> from prediction using the full model (including ",
            "the PRS).</li>"
        "<li>R<sup>2</sup> from prediction using the reduced model (excluding ",
            "the PRS).</li>",
        "<li>Adjusted R<sup>2</sup>: Full R<sup>2</sup> – Reduced ",
            "R<sup>2</sup>.</li>",
        "</ul>"
    ),
    `Correlation`=paste0(
        "The plots depict the following R measurements:",
        "<ul>",
        "<li>R from prediction using the full model (including the PRS).</li>",
        "<li>R from prediction using the reduced model (excluding the PRS).",
            "</li>",
        "</ul>"
    )
)

metDir <- list(
    `PRS R<sup>2</sup>`="higher",
    `RMSE`="lower",
    `MAE`="lower",
    `Predicted R<sup>2</sup>`="higher",
    `Correlation`="higher"
)
```

# Summary {.tabset .tabset-pills}

## Input options

### Input options

<div id="opts_container">

**Input dataset: **
```{r summary_input_options_1}
cat("a GWASExperiment object with ",nrow(gwe),
        " markers (SNPs) and ",ncol(gwe)," samples")
```

**Phenotypic response:** 
```{r summary_input_options_2}
cat(args$phenotype)
```

**Phenotypic covariates:** 
```{r summary_input_options_3}
cat(paste(args$covariates,collapse=", "))
```

**Use population structure covariates (PCA):** 
```{r summary_input_options_4}
cat(ifelse(args$pcs,"Yes","No"))
```

**Number of Principal Components:** 
```{r summary_input_options_5}
cat(ifelse(args$npcs==0,"Automatic (Tracy-Widom test)",as.character(args$npcs)))
```

**Training set split size:** 
```{r summary_input_options_6}
cat(paste0(100*args$trainSize,"%"))
```

**Number of PRS extraction iterations:** 
```{r summary_input_options_7}
cat(args$niter)
```

**Best PRS resolution method:** 
```{r summary_input_options_8}
cat(args$resolution)
```

**Number of PRS resolution step:** 
```{r summary_input_options_9}
cat(paste(args$step,collapse=", "))
```

**Minimum SNP frequency for PRS inclusion:** 
```{r summary_input_options_10}
cat(args$minFreq)
```

**Minimum number of SNPs in PRS:** 
```{r summary_input_options_11}
cat(args$minSnps)
```

**Drop quantiles with same SNPs:** 
```{r summary_input_options_12}
cat(ifelse(args$dropSameQuantiles,"Yes","No"))
```

**PRS marker (SNP) aggregation method:** 
```{r summary_input_options_13}
cat(args$aggregation)
```

**SNP effect weighting method:** 
```{r summary_input_options_14}
cat(args$effectWeight)
```

**PRS selection method:** 
```{r summary_input_options_15}
cat(args$prsSelectMethod)
```

**PRS selection criterion:** 
```{r summary_input_options_16}
cat(args$prsSelectCrit)
```

**PRS selection averaging method:** 
```{r summary_input_options_17}
cat(args$prsSelectStat)
```

**PRS selection adjusted R<sup>2</sup> type:** 
```{r summary_input_options_18}
cat(args$prsSelectR2)
```

**Genotype quality controls:** 
```{r summary_input_options_19}
cat("<ul>")
cat("<li><em class=lightbold>SNP call rate:</em> ",args$filters$snpCallRate,
    "</li>")
cat("<li><em class=lightbold>Sample call rate:</em> ",
    args$filters$sampleCallRate,"</li>")
cat("<li><em class=lightbold>Minor allele frequency:</em> ",args$filters$maf,
    "</li>")
cat("<li><em class=lightbold>Hardy-Weinberg equilibrium:</em> ",
    args$filters$hwe,"</li>")
cat("<li><em class=lightbold>Heterozygosity cutoff statistic:</em> ",
    args$filters$heteroStat,"</li>")
cat("<li><em class=lightbold>Heterozygosity cutoff scale factor:</em> ",
    args$filters$heteroFac,"</li>")
cat("<li><em class=lightbold>Heterozygosity hard cutoff:</em> ",
    args$filters$heteroHard,"</li>")
cat("<li><em class=lightbold>Automatic sample removal with robust PCA:</em> ",
    ifelse(args$filters$pcaOut,"Yes","No"),"</li>")
cat("<li><em class=lightbold>Robust PCA method:</em> ",args$filters$pcaRobust,
    "</li>")
cat("<li><em class=lightbold>Number of PCs for robust PCA:</em> ",
    ifelse(is.na(args$filters$nPC),"auto",args$filters$nPC),"</li>")
cat("<li><em class=lightbold>Linkage Disequilibrium (LD) cutoff:</em> ",
    ifelse(is.na(args$filters$LD),"none",args$filters$LD),"</li>")
cat("<li><em class=lightbold>Identity by descent (IBD) cutoff:</em> ",
    ifelse(is.na(args$filters$IBD),"none",args$filters$IBD),"</li>")
cat("<li><em class=lightbold>Inbreed coefficient cutoff:</em> ",
    ifelse(is.na(args$filters$IBD),"none",args$filters$LD),"</li>")
cat("</ul>")
```

**General PCA method:** 
```{r summary_input_options_20}
cat(args$pcaMethod)
```

**Impute missing genotypes:** 
```{r summary_input_options_21}
cat(ifelse(args$imputeMissing,"Yes","No"))
```

**Missing genotype imputation strategy:** 
```{r summary_input_options_22}
cat(args$imputeMethod)
```

**General PCA method:** 
```{r summary_input_options_23}
cat(args$pcaMethod)
```

**GWA test(s) for summary statistics:** 
```{r summary_input_options_24}
cat(paste(args$gwaMethods,collapse=", "))
```

**GWA test(s) for summary statistics:** 
```{r summary_input_options_25}
cat(paste(args$gwaMethods,collapse=", "))
```

**GWA test(s) p-value combination method:** 
```{r summary_input_options_26}
cat(args$gwaCombine)
```

**General Linear Model options:** 
```{r summary_input_options_27}
cat("<ul>")
cat("<li><em class=lightbold>Model family:</em> ",
    ifelse(is.null(args$glmOpts$family),"automatic selection",
    args$glmOpts$family),"</li>")
cat("<li><em class=lightbold>SNP regression chunk size:</em> ",
    args$glmOpts$size,"</li>")
cat("</ul>")
```

**rrBLUP (ridge regression) options:** 
```{r summary_input_options_28}
cat("<ul>")
cat("<li><em class=lightbold>Principal Components method:</em> ",
    args$rrblupOpts$pcblup,"</li>")
cat("<li><em class=lightbold>Number of PCs:</em> ",
    ifelse(is.null(args$rrblupOpts$npcs),"auto estimate",args$rrblupOpts$npcs),
    "</li>")
cat("</ul>")
```

**statgenGWAS options:** 
```{r summary_input_options_29}
cat("<ul>")
cat("<li><em class=lightbold>Kinship estimation method:</em> ",
    args$statgenOpts$kinship,"</li>")
cat("<li><em class=lightbold>Restricted Maximum Likelihood (REML) method:</em>",
    args$statgenOpts$reml,"</li>")
cat("<li><em class=lightbold>Effect estimate kinship method:</em> ",
    args$statgenOpts$gls,"</li>")
cat("</ul>")
```

**SNPTEST options:** 
```{r summary_input_options_30}
cat("<ul>")
cat("<li><em class=lightbold>Basic association test type:</em> ",
    args$snptestOpts$test,"</li>")
cat("<li><em class=lightbold>Genotype model type:</em> ",args$snptestOpts$model,
    "</li>")
cat("<li><em class=lightbold>SNPTEST workspace:</em> ",
    ifelse(is.null(args$snptestOpts$workspace),"default",
    args$snptestOpts$workspace),"</li>")
cat("</ul>")
```

**PLINK options:** 
```{r summary_input_options_31}
cat("<ul>")
cat("<li><em class=lightbold>Effect estimation type:</em> ",
    args$plinkOpts$effect,"</li>")
cat("<li><em class=lightbold>Random seed:</em> ",args$plinkOpts$seed,"</li>")
cat("<li><em class=lightbold>PLINK workspace:</em> ",
    ifelse(is.null(args$plinkOpts$workspace),"default",
    args$plinkOpts$workspace),"</li>")
cat("</ul>")
```

**PRS extraction method(s):** 
```{r summary_input_options_32}
cat(paste(args$prsMethods,collapse=", "))
```

**lassosum options:** 
```{r summary_input_options_33}
cat("<ul>")
cat("<li><em class=lightbold>Ancestry for LD regions:</em> ",
    args$lassosumOpts$anc,"</li>")
cat("<li><em class=lightbold>Validation method:</em> ",args$lassosumOpts$valid,
    "</li>")
cat("</ul>")
```

**PRSice-2 options:** 
```{r summary_input_options_34}
cat("<ul>")
cat("<li><em class=lightbold>Clumping window size (kb):</em> ",
    args$prsiceOpts$clump_kb,"</li>")
cat("<li><em class=lightbold>Clumping R<sup>2</sup> threshold:</em> ",
    args$prsiceOpts$clump_r2,"</li>")
cat("<li><em class=lightbold>Clumping p-value threshold:</em> ",
    args$prsiceOpts$clump_p,"</li>")
cat("<li><em class=lightbold>Clumping window size (kb):</em> ",
    args$prsiceOpts$clump_kb,"</li>")
cat("<li><em class=lightbold>PRS calculation method:</em> ",
    args$prsiceOpts$score,"</li>")
cat("<li><em class=lightbold>Number of permutations:</em> ",
    args$prsiceOpts$perm,"</li>")
cat("<li><em class=lightbold>Random seed:</em> ",args$prsiceOpts$seed,"</li>")
cat("</ul>")
```

**Main workspace:** 
```{r summary_input_options_35}
cat(ifelse(is.null(args$prsWorkspace),"auto",args$prsWorkspace))
```

**Cleanup level:** 
```{r summary_input_options_36}
cat(args$cleanup)
```

**Logging device:** 
```{r summary_input_options_37}
cat(args$logging)
```

**De novo run output type:** 
```{r summary_input_options_38}
cat(args$dnOutput)
```

**Final output type:** 
```{r summary_input_options_39}
cat(args$output)
```

**Pipeline continuation:** 
```{r summary_input_options_40}
cat(ifelse(args$continue,"Yes","No"))
```

**De novo workspace for validation:** 
```{r summary_input_options_41}
cat(ifelse(is.null(args$useDenovoWorkspace),"none",
    ifelse(is.list(args$useDenovoWorkspace),"previous run",
    args$useDenovoWorkspace)))
```

**Run ID:** 
```{r summary_input_options_42}
cat(ifelse(is.null(args$runId),"auto",args$runId))
```

**Dataset split for evaluation:** 
```{r summary_input_options_43}
cat(args$evalOnSplit)
```

**Evaluation framework:** 
```{r summary_input_options_44}
cat(args$evalWith)
```

**Cores percentage for parallel run:** 
```{r summary_input_options_45}
cat(ifelse(is.null(args$rc),"none",paste0(100*args$rc,"%")))
```

</div>

## Basic QC Results

### Basic quality contol results

The following tables summarize how many SNPs and samples were excluded from
further analysis after the application of QC filters:

```{r qc_summary}
qct <- filterRecord(gwe)[,c(4,2,1,3,5),drop=FALSE]
rownames(qct) <- NULL
qct %>% 
    kbl() %>%
    kable_styling(bootstrap_options=c("striped","hover","condensed",
        "responsive"))
```

## Command

### Input command

The Polygenic Risk Score extraction and evaluation analysis and this report were 
generated using the following command:

```{r fun_call}
cat("<pre><code>")
cat(paste(funCall,collapse="<br/>"))
cat("</code></pre>")
```

# Selection {.tabset .tabset-pills}

The **Evaluation** section summarizes the performance of one or more performed
GWA tests with respect to the associative power of the derived PRS as extracted 
through the `prisma` iterative procedure. The aforementioned summary comprises
several assessment graphics which aid the automatic selection of the *best*
performing PRS but also allow the user to adjust this selection based on other
possible solutions and an iterative cross-validation procedure using the whole 
input dataset. The section comprises the following:

* **PRS selection plots**: These plots can be used to inspect the `PRSice` 
adjusted R<sup>2</sup> that explains the phenotypic variability introduced by 
the PRS, or its `prisma` adjusted version that penalizes the R<sup>2</sup>
according to the number of SNP markers included in the PRS candidates.
* **Model cross-validation plots** for various evaluation metrics.

Each plot is accompanied by a small explanation text and interpretation 
instructions.


```{r multi_r2_plot, fig.width=7, fig.height=5}
if (length(prismaOut$results) > 1) { # Plot of baselines
    cat("<h3>Evaluation of performed GWA tests</h3>")
    
    cat("<div class=\"figure-hint\">")
    cat("The following figure depicts the mean PRSice-2 adusted R<sup>2</sup>",
        "+/- its standard deviation, for each performed GWA test across",
        args$niter," PRS extraction iterations. Apart from bar height, higher",
        "adjusted R<sup>2</sup>s are depicted by lighter color. In principle,",
        "the method presenting the higher adjusted R<sup>2</sup> has yielded",
        "the best results over ",args$niter," iterations.")
    cat("</div>")
    
    R2 <- unlist(lapply(names(prismaOut$results),function(n,D) {
        return(mean(D[[n]]$reportData$evalMetrics$baseline))
    },prismaOut$results),use.names=FALSE)
    SD <- unlist(lapply(names(prismaOut$results),function(n,D) {
        return(sd(D[[n]]$reportData$evalMetrics$baseline))
    },prismaOut$results),use.names=FALSE)
    testNames <- unlist(msgs$stat[names(prismaOut$results)],use.names=FALSE)
    
    ggdata <- data.frame(
        R2=R2,
        SD=SD,
        Test=factor(testNames,levels=testNames)
    )
    g <- ggplot(ggdata,aes(x=Test,y=R2)) + 
        geom_bar(aes(fill=R2),stat="identity",width=0.7) +
        geom_errorbar(aes(ymin=R2-SD,ymax=R2+SD),width=0.2) +
        xlab("\nGWA test") +
        ylab(expression("Mean PRSice adjusted R"^"2")) +
        theme_bw() + 
        theme(
            axis.title.x=element_text(size=14),
            axis.title.y=element_text(size=14,face="bold"),
            axis.text.x=element_text(size=12,face="bold"),
            axis.text.y=element_text(size=12,face="bold")
        )
    g
}
```

The following tabs contain evaluation plots for each performed GWA test.

```{r selection_basic, fig.width=14, fig.height=6}
cat("<h3>Evaluation of <em>de novo</em> extracted PRSs</h3>")
for (m in names(prismaOut$results)) {
    pandoc.header(paste0(msgs$stat[[m]]," {.tabset .tabset-pills}"),level=2)
    
    # De novo extraction part
    cat("<div class='figure-hint'>")
    cat("The following figure depicts the mean PRS R<sup>2</sup> +/- its",
        "standard deviation (barplots and errorbars), for PRS candidates",
        "assembled from SNPs at different frequencies of appearance in the",
        "PRS candidates across ",args$niter," PRISMA PRS extraction",
        "iterations. The vertical axis depicts the mean adjusted PRS",
        "R<sup>2</sup> while the horizotnal axis depicts the number of SNPs in",
        "each PRS candidate. The number inside the parentheses, next to the",
        "number of SNPs in the horizontal axis depicts the SNP frequency of",
        "appearance in the PRS. For example, **245 (8)** means that the PRS at",
        "that particular R<sup>2</sup> consists of 245 SNPs that appear at",
        "least 8 times over ",args$niter," iterations. The colorscale denotes",
        "the statistical significance (p-value in -log<sub>10</sub> scale) of",
        "the adjusted R<sup>2</sup> distribution over ",args$niter," *de novo*",
        "PRS extraction iterations (baseline R<sup>2</sup>) as compared to the", 
        "adjusted R<sup>2</sup> distribution of each PRISMA assembled PRS",
        "candidate in the horizontal axis. The mean baseline R<sup>2</sup> is",
        "depicted with the dashed grey horizontal line, and the dotted grey",
        "horizontal lines depict the standard deviation of the former. The",
        "best performing PRSs should be among the ones showing higher",
        "R<sup>2</sup> as compared to the baseline along with statistical",
        "significance.")
    cat("</div>")
    cat("<div>")
    print(prismaOut$results[[m]]$reportData$plots$r2snp)
    cat("</div>")
       
    cat("<div class='figure-hint'>")
    cat("The following figure depicts the mean PRISMA PRS R<sup>2</sup> in the",
        "vertical axis, which penalizes the PRS R<sup>2</sup> according to the",
        "number of SNPs that are included in the PRS. The best performing PRSs", 
        "should be among the ones showing higher PRISMA adjusted R<sup>2</sup>", 
        "values along with statistical significance.")
    cat("</div>")
    cat("<div>")
    print(prismaOut$results[[m]]$reportData$plots$ar2snp)
    cat("</div>")
    
    cat("<div class='figure-hint'>")
    cat("The following figure depicts the mean PRS R<sup>2</sup> in",
        "relationship with the number of SNPs in the PRS. Lower frequencies",
        "mean that SNPs appear in the PRS a few times over ",args$niter,
        " PRISMA iterations. The horizontal axis depicts the number of SNPs in",
        "log<sub>10</sub> scale.")
    cat("</div>")
    cat("<div>")
    print(prismaOut$results[[m]]$reportData$plots$r2fr)
    cat("</div>")
}
```

```{r cv_basic, fig.width=14, fig.height=6}
if (!is.null(cvMetricsOut)) {
    pandoc.header("Cross validation {.tabset .tabset-pills}",level=1)
    
    for (m in names(prismaOut$results)) {
        if (!is.null(cvMetricsOut[[m]])) {
            cat("<h4>Cross-validation using the best PRS candidates for ",
                msgs$stat[[m]],"</h3>")
            
            cat(
                "Each of the following tabs contains evaluation plots produced",
                "after model cross-validations with (<strong>full)</strong>",
                "or without (<strong>reduced</strong>) the PRS across",
                nrow(cvMetricsOut[[m]][[1]][[1]]),"cross-validation",
                "iterations. The cross-validation iterations are performed",
                "with different percentages of withheld samples, and namely,",
                "leaving out, ",
                paste(paste(100*as.numeric(names(cvMetricsOut[[m]][[1]])),"%",
                    sep=""),collapse=", "),
                " of the samples. Each time, the rest of the samples are used",
                "to build the regression model including or excluding the PRS.",
                "The following model evaluation metrics are collected:"
            )
            
            cat("<ul>")
            cat("<li>Model fit as depicted by the R<sup>2</sup> coefficient",
                "(<strong>PRS R2</strong>).</li>")
            cat("<li>Root Mean Square Error (<strong>RMSE</strong>). The RMSE",
                "is the standard deviation of the residuals (prediction",
                "errors). The predictions are performed by applying the model",
                "to the leave-out samples and RMSE measures how concentrated",
                "the data are around the line of best fit and is robust to", 
                "outliers.</li>")
            cat("<li>Mean Absolute Error (<strong>MAE</strong>). The MAE is",
                "a measure of errors between paired observations (here",
                "original values and predictions) and is simply the mean",
                "difference between observed and predicted phenotype",
                "values.</li>")
            cat("<li>Squared correlation coefficient (R<sup>2</sup>) of the",
                "observed versus the predicted phenotype values.</li>")
            cat("<li>Correlation coefficient (R<sup>2</sup>) of the",
                "observed versus the predicted phenotype values.</li>")
            cat("</ul>")
            
            cvPlots <- vector("list",length(theCvMetrics))
            names(cvPlots) <- names(theCvMetrics)
            for (e in names(theCvMetrics)) {
                pandoc.header(paste0(e," {.tabset .tabset-pills}"),level=3)
                
                # Create CV plots
                cvPlots <- plotCvMetrics(cvMetricsOut[[m]],theCvMetrics[[e]])
                
                # What we see
                cat(cvMetExpl[[e]])
            
                # A plot across leave-out percentages, if performed
                if (length(cvMetricsOut[[m]][[1]]) > 1) {
                    cat("<div class='figure-hint'>")
                    cat("The following plot depicts the average values of",e,
                        "and their standard deviations across",
                        length(cvMetricsOut[[m]][[1]]),
                        "different leave-out sample percentages. Its purpose",
                        "is to evaluate the stability of the model based on", 
                        "different number of samples used for fit and",
                        "prediction, with or without the PRS. Each panel",
                        "corresponds to a PRS candidate with its number of",
                        "SNPs displayed on the top. A good PRS should also", 
                        "result in a stable model.")
                    cat("</div>")
                    cat("<div>")
                    print(cvPlots$cvBased)
                    cat("</div>")
                }
                
                # Detailed plots for each CV percentage
                for (pct in names(cvPlots$prsBased)) {
                    pctp <- paste0(100*as.numeric(pct),"%")
                    pandoc.header(pctp,level=4)
                    
                    cat("<div class='figure-hint'>")
                    cat("The following plot depicts the average values of",e,
                        "and their standard deviations across the PRS",
                        "candidates while leaving out",pctp,"samples. The",
                        "best candidate should show",metDir[[e]],e)
                    cat("</div>")
                    
                    cat("<div>")
                    print(cvPlots$prsBased[[pct]])
                    cat("</div>")
                }
            }
            
        }
    }
}

```

<!--
- For across %
The following plot depicts the average values of … and their standard deviations across … different leave-out sample percentages. Its purpose is to evaluate the stability of the model based on different number of samples used for fit and prediction, with or without the PRS. Each panel corresponds to a PRS candidate with … SNPs. A good PRS should also result in a stable model.

- For each metric
The following plot depicts the average values of … and their standard deviations across … PRS candidates while leaving out … % samples. The best candidate should show higher/lower …
-->






# Results {.tabset .tabset-pills}

